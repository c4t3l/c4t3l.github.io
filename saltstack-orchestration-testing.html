<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Robert Callicotte">
  <meta name="description" content="Posts and writings by Robert Callicotte">

  <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="robbyc.io Atom" />
  <link href="/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="robbyc.io RSS" />

<meta name="keywords" content="salt, qemu, devops">

  <title>
    robbyc.io
&ndash; Saltstack Orchestration Testing  </title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="">
        <img src="/images/me-guitar.jpg" alt="logo">
      </a>
      <h2><a href="">robbyc.io</a></h2>
      <p>♫♩♪♪♪♪♫</p>
      <ul>
        <li><a href="/pages/about-me.html">About Me</a></li>
        <li><a href="https://github.com/c4t3l" target="_blank">GitHub</a></li>
        <li><a href="https://twitter.com/robbycl2v" target="_blank">Twitter</a></li>
        <li><a href="mailto:rcallicotte@gmail.com" target="_blank">Email</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="">Index</a> &brvbar; <a href="/archives.html">Archives</a>
      &brvbar; <a href="/feeds/all.atom.xml">Atom</a>
      &brvbar; <a href="/feeds/all.rss.xml">RSS</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="/saltstack-orchestration-testing.html">Saltstack Orchestration Testing</a></h1>
  </div>
  <div class="article_text">
    <h3>Simple Setup</h3>
<p>This simple setup defines the initial POC for this work.  The following items must exist:</p>
<p>1 - Default Qemu image
2 - Socket networking for qemu configured
3 - User mode (SLIRP) networking for qemu configured
4 - Entropy device passthru active in qemu? (see virtio section of qemu manual)
5 - Salt minion already installed in qemu image</p>
<h3>Qemu commands</h3>
<p>The following will be translated to python for use with pytest</p>
<div class="highlight"><pre><span></span># Test system1 mcast socket
qemu-system-x86_64 -daemonize \
-display gtk \
-m 512 \
-enable-kvm \
-device e1000,netdev=n0,mac=52:54:00:12:34:56 \
-netdev user,id=n0,hostfwd=tcp::1111-:22 \
-device e1000,netdev=n1,mac=52:54:00:12:34:57 \
-netdev socket,id=n1,mcast=230.0.0.1:1234,localaddr=127.0.0.1 \
-device virtio-rng-pci \
-device virtio-scsi-pci,id=scsi \
-device scsi-hd,drive=drive0 \
-drive if=none,id=drive0,snapshot=on,file=/var/lib/libvirt/images/centos7_test.qcow2

# Test system2 mcast socket
qemu-system-x86_64 -daemonize \
-display gtk \
-m 512 \
-enable-kvm \
-device e1000,netdev=n2,mac=52:54:00:12:34:58 \
-netdev user,id=n2,hostfwd=tcp::2222-:22 \
-device e1000,netdev=n3,mac=52:54:00:12:34:59 \
-netdev socket,id=n3,mcast=230.0.0.1:1234,localaddr=127.0.0.1 \
-device virtio-rng-pci \
-device virtio-scsi-pci,id=scsi \
-device scsi-hd,drive=drive0 \
-drive if=none,id=drive0,snapshot=on,file=/var/lib/libvirt/images/centos7_test.qcow2

# Test system3 mcast socket
qemu-system-x86_64 -daemonize \
-display gtk \
-m 512 \
-enable-kvm \
-device e1000,netdev=n4,mac=52:54:00:12:34:60 \
-netdev user,id=n4,hostfwd=tcp::3333-:22 \
-device e1000,netdev=n5,mac=52:54:00:12:34:61 \
-netdev socket,id=n5,mcast=230.0.0.1:1234,localaddr=127.0.0.1 \
-device virtio-rng-pci \
-device virtio-scsi-pci,id=scsi \
-device scsi-hd,drive=drive0 \
-drive if=none,id=drive0,snapshot=on,file=/var/lib/libvirt/images/centos7_test.qcow2
</pre></div>


<h3>Qemu setup</h3>
<p>Once the images are booted, networking needs to be configured on the guests to allow connectivity between them.</p>
<p>Host 1 (master): </p>
<div class="highlight"><pre><span></span>nmcli con mod &quot;Wired connection 2&quot; ipv4.addresses &quot;10.0.200.101/24&quot;
nmcli con mod &quot;Wired connection 2&quot; ipv4.method manual

Git setup required
</pre></div>


<p>Host 2 (minion):</p>
<div class="highlight"><pre><span></span>nmcli con mod &quot;Wired connection 2&quot; ipv4.addresses &quot;10.0.200.102/24&quot;
nmcli con mod &quot;Wired connection 2&quot; ipv4.method manual

echo &quot;10.0.200.101 cicdsalt&quot; &gt;&gt; /etc/hosts
echo &quot;minion0&quot; &gt; /etc/salt/minion_id
systemctl restart salt-minion
</pre></div>


<p>Host 3 (minion):</p>
<div class="highlight"><pre><span></span>nmcli con mod &quot;Wired connection 2&quot; ipv4.addresses &quot;10.0.200.103/24&quot;
nmcli con mod &quot;Wired connection 2&quot; ipv4.method manual

echo &quot;10.0.200.101 cicdsalt&quot; &gt;&gt; /etc/hosts
echo &quot;minion1&quot; &gt; /etc/salt/minion_id
systemctl restart salt-minion
</pre></div>


<p>SSH to guests via <code>ssh -p1111 kitchen@localhost -o StrictHostKeyChecking=no</code></p>
  </div>
  <div class="article_meta">
    <p>Posted on: Sat 08 June 2019</p>
    <p>Category: <a href="/category/saltstack.html">saltstack</a>
 &ndash; Tags:
      <a href="/tag/salt.html">salt</a>,      <a href="/tag/qemu.html">qemu</a>,      <a href="/tag/devops.html">devops</a>    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; Robert Callicotte. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>