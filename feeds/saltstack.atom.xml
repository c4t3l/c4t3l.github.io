<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>robbyc.io - saltstack</title><link href="/" rel="alternate"></link><link href="/feeds/saltstack.atom.xml" rel="self"></link><id>/</id><updated>2019-06-08T00:00:00-05:00</updated><entry><title>Saltstack Orchestration Testing</title><link href="/saltstack-orchestration-testing.html" rel="alternate"></link><published>2019-06-08T00:00:00-05:00</published><updated>2019-06-08T00:00:00-05:00</updated><author><name>Robert Callicotte</name></author><id>tag:None,2019-06-08:/saltstack-orchestration-testing.html</id><summary type="html">&lt;p&gt;Testing Saltstack orchestration&lt;/p&gt;</summary><content type="html">&lt;h3&gt;Simple Setup&lt;/h3&gt;
&lt;p&gt;This simple setup defines the initial POC for this work.  The following items must exist:&lt;/p&gt;
&lt;p&gt;1 - Default Qemu image
2 - Socket networking for qemu configured
3 - User mode (SLIRP) networking for qemu configured
4 - Entropy device passthru active in qemu? (see virtio section of qemu manual)
5 - Salt minion already installed in qemu image&lt;/p&gt;
&lt;h3&gt;Qemu commands&lt;/h3&gt;
&lt;p&gt;The following will be translated to python for use with pytest&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# Test system1 mcast socket
qemu-system-x86_64 -daemonize \
-display gtk \
-m 512 \
-enable-kvm \
-device e1000,netdev=n0,mac=52:54:00:12:34:56 \
-netdev user,id=n0,hostfwd=tcp::1111-:22 \
-device e1000,netdev=n1,mac=52:54:00:12:34:57 \
-netdev socket,id=n1,mcast=230.0.0.1:1234,localaddr=127.0.0.1 \
-device virtio-rng-pci \
-device virtio-scsi-pci,id=scsi \
-device scsi-hd,drive=drive0 \
-drive if=none,id=drive0,snapshot=on,file=/var/lib/libvirt/images/centos7_test.qcow2

# Test system2 mcast socket
qemu-system-x86_64 -daemonize \
-display gtk \
-m 512 \
-enable-kvm \
-device e1000,netdev=n2,mac=52:54:00:12:34:58 \
-netdev user,id=n2,hostfwd=tcp::2222-:22 \
-device e1000,netdev=n3,mac=52:54:00:12:34:59 \
-netdev socket,id=n3,mcast=230.0.0.1:1234,localaddr=127.0.0.1 \
-device virtio-rng-pci \
-device virtio-scsi-pci,id=scsi \
-device scsi-hd,drive=drive0 \
-drive if=none,id=drive0,snapshot=on,file=/var/lib/libvirt/images/centos7_test.qcow2

# Test system3 mcast socket
qemu-system-x86_64 -daemonize \
-display gtk \
-m 512 \
-enable-kvm \
-device e1000,netdev=n4,mac=52:54:00:12:34:60 \
-netdev user,id=n4,hostfwd=tcp::3333-:22 \
-device e1000,netdev=n5,mac=52:54:00:12:34:61 \
-netdev socket,id=n5,mcast=230.0.0.1:1234,localaddr=127.0.0.1 \
-device virtio-rng-pci \
-device virtio-scsi-pci,id=scsi \
-device scsi-hd,drive=drive0 \
-drive if=none,id=drive0,snapshot=on,file=/var/lib/libvirt/images/centos7_test.qcow2
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Qemu setup&lt;/h3&gt;
&lt;p&gt;Once the images are booted, networking needs to be configured on the guests to allow connectivity between them.&lt;/p&gt;
&lt;p&gt;Host 1 (master): &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nmcli con mod &amp;quot;Wired connection 2&amp;quot; ipv4.addresses &amp;quot;10.0.200.101/24&amp;quot;
nmcli con mod &amp;quot;Wired connection 2&amp;quot; ipv4.method manual

Git setup required
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Host 2 (minion):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nmcli con mod &amp;quot;Wired connection 2&amp;quot; ipv4.addresses &amp;quot;10.0.200.102/24&amp;quot;
nmcli con mod &amp;quot;Wired connection 2&amp;quot; ipv4.method manual

echo &amp;quot;10.0.200.101 cicdsalt&amp;quot; &amp;gt;&amp;gt; /etc/hosts
echo &amp;quot;minion0&amp;quot; &amp;gt; /etc/salt/minion_id
systemctl restart salt-minion
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Host 3 (minion):&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nmcli con mod &amp;quot;Wired connection 2&amp;quot; ipv4.addresses &amp;quot;10.0.200.103/24&amp;quot;
nmcli con mod &amp;quot;Wired connection 2&amp;quot; ipv4.method manual

echo &amp;quot;10.0.200.101 cicdsalt&amp;quot; &amp;gt;&amp;gt; /etc/hosts
echo &amp;quot;minion1&amp;quot; &amp;gt; /etc/salt/minion_id
systemctl restart salt-minion
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;SSH to guests via &lt;code&gt;ssh -p1111 kitchen@localhost -o StrictHostKeyChecking=no&lt;/code&gt;&lt;/p&gt;</content><category term="salt"></category><category term="qemu"></category><category term="devops"></category></entry></feed>